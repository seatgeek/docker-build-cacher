sudo: false
language: c
compiler: gcc
cache:
  directories:
  - "$HOME/.stack"
  timeout: 300
git:
  depth: 100
matrix:
  include:
  - env: ARGS="--resolver lts-12.8"
    dist: xenial
    before_deploy:
    - ldd $(which docker-build-cacher) || true
    - curl -sSL https://github.com/upx/upx/releases/download/v3.94/upx-3.94-amd64_linux.tar.xz
      | tar -x --xz --strip-components=1 -C ~/.local/bin upx-3.94-amd64_linux/upx
    - upx -q --best --ultra-brute "./releases/${BINARY_NAME}"
    deploy:
      provider: releases
      api_key: &1
        secure: bAcEdQB7Hk4yDz58u5oo8aEoitbbobaqW7Dr58asJHnm0KG3g1lJqCrgRP2ldbmG8I9zj1osfw0qGCNc3MZW2sV5AaWqxUGC1Sw2jmz0fqdajk8f0bZXZMECFeryPeXmPRftw0VAKz5dVw5wzjunaAVUEuCC3B4a80v/3+Qj8t2FaslG+uNoTTEEzHPfwgowYPQf+QR1Ob3lWM41g0ORC9mgYAD/PIUi8mnxCVRExUecHwhTM1A8UMo/MDVQuv3cclJ+Xc10O9KTCr7tf9uh4g2ZY4RD/aW5zuUt1tqMVJfcL/BQi5wOrhJd0jwMW8LZg0eBypezXZ70CC1Eb+vwe7OUrDlUroyzPUsOXd7u6LAWe+dBE0zNwvWXFnUF6ls8cJDhrVoSmVV3SFd208/xmemDgMmtBWwcjxyCM3kMyCBx1T6nkXQ4czS5Nvn1dav87sgyowR52W52oiyomJyJtBrmrlP/2qgNAJgQuzah/ltuBBvyGCaiwFQFHzUjUNv/ENCNP06aEVTLdbkLXLNfvlw6NZbn8KIOGFmSncLT3hNtcRhS6XnrCIyOc6hYelzVLXPNhmWFo7Ob3/1GFSvlWVmzHEp5+AeTYAQmsAZMAe/E5ofVSrU/3DhXvxMjzdOq5bZ9FsOMfooxYIPp05kVsW4H6dB8kIUqQcWTntt4ys4=
      file: "./releases/${BINARY_NAME}"
      skip_cleanup: true
      draft: true
      tag_name: "${TRAVIS_TAG}"
      on: &2
        tags: true
  - env: ARGS="--resolver lts-12.8"
    before_deploy:
    - otool -L $(which docker-build-cacher) || true
    - brew update > /dev/null
    - brew install upx
    - upx -q --best --ultra-brute "./releases/${BINARY_NAME}"
    deploy:
      provider: releases
      api_key: *1
      file: "./releases/${BINARY_NAME}"
      skip_cleanup: true
      draft: true
      tag_name: "${TRAVIS_TAG}"
      on: *2
    os: osx
before_install:
- export BINARY_NAME="docker-build-cacher-$(uname -s)-$(uname -m)"
- mkdir -p ~/.local/bin
- |
  if [[ "${TRAVIS_OS_NAME}" = "osx" ]]
  then
    travis_retry curl -sSL https://www.stackage.org/stack/${TRAVIS_OS_NAME}-x86_64 \
      | tar xz --strip-components=1 -C ~/.local/bin --include   '*/stack'
  else
    travis_retry curl -sSL https://www.stackage.org/stack/${TRAVIS_OS_NAME}-x86_64 \
      | tar xz --strip-components=1 -C ~/.local/bin --wildcards '*/stack'
  fi
install:
- travis_retry stack --no-terminal --install-ghc $ARGS test --only-dependencies
- stack --no-terminal $ARGS install --ghc-options='-fPIC'
script:
- docker-build-cacher -h
after_success:
- mkdir -p ./releases/
- cp "$(which docker-build-cacher)" "./releases/${BINARY_NAME}"
deploy:
  provider: releases
  draft: true
  skip_cleanup: true
  api_key:
    secure: "3tpE+jf1r8uebkitLCxpLFwZfFtPdb/zsEGtqu56oD9LjIE7nEyEeOXUaE8c2KSrg+pWhhTOvShlVRHPXUJAO86mowLnnjEnyM/kIWt4tb89jYmpr+EwLF6qG6AxMk19lImlO2156e0yvl2k4p3NR0Y/CimEyPiyxeRT02cF6TJdP1weOX+6o9cXOG5DZowX+FbOq6WwkQvW3uiPQ0eJkknrirGbbMY4fi3Jgx/Uy/aq5isgMETql53xvd8hoSmoD3p99YV4jc6iF+DXIjEn+tyEEdi/OFg9gNT+R+vYvJ8/WSGpuMyw1UeI7ErGTa6M4kn9/eY5N3abrUNKgs8tD4ZH4EzLym12/dOD3YAcPjD6dqM2cvEUGUvHG9vCEj/012QzeYUoIlgaPCOg0FVTNtpG2OzrQVAh/7xeLz6bPAkKmng2ZAtkHreuwBKqZ4CG9figs7iWYn+Of6iePPGLRoUuvJ5ys749q7Ir9sFwiZF5BYc7DA+DPbqXir0uFBpXikBMQ+cgPsF/z0kO86aB0IcBDiOCtfTxZ+xbIcWq2ABM40NPlp8D3PRAg65hKvO2cjcoD97WxLfA5rcUrsW+0O4JKl/zJzACoGY53GzFMSQwLP6NCZKlE73OFfQupbP3Ihxt/c3r11zdPytM3wZYEE8tQia3lbp7KcMpezbTNRw="
  file: "./releases/${BINARY_NAME}"
  on:
    tags: true
